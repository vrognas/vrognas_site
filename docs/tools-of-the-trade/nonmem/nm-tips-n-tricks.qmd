---
title: "NONMEM Tips-n-Tricks"
code-overflow: scroll
---

log-transform both sides: [cognigen.com/nonmem/nm/99apr232002.html](cognigen.com/nonmem/nm/99apr232002.html)

## Analysis

::: {.callout-tip}

### Dataset

* Start every dataset with a "Comment" column, the `IGNORE=@` will then ignore a row if there is a text comment!
    * The second column should be a `REF` column with each line number

* PK Studies:
    * "Intensive studies" (Phase 1/2)
        * Few subjects (homogeneous)
        * Single dose
        * Frequent (rich) sampling
    * "Population studies" (Phase 3/4)
        * Many subjects (heterogeneous)
        * Multiple dose
        * Sparse sampling

:::

::: {.callout-tip}

### Modeling

#### Time-to-event

* Non-parametric analysis: Log-rank test
* Semi-parametric analysis: Cox PH (does not assume a distribution)
* Parametric: Weibull, Gompertz, etc  (fit a distribution)

Weibull\*COV *forces* proportional hazard (Credit: Andrew Hooker)

* TTE simulations can be done either with a dataset containing all possible event times, or using `MTIME` (Credit: Joakim Nyberg)

* logistic=expit=inverse logit
    * logit≈probit(scaled)

#### Coding

* When you use `F`, `CMT` matters (Credit: Maria Kjellsson)
* `ETADER=3`: Get out of a local minima (Credit: Rikard Nordgren)
* Use `$COV MATRIX=R` for consistency between statistical software.

#### Faster parallel NONMEM:

```zsh
execute -nmfe_options="[sbatchargs=--threads-per-core=1] -maxlim=2  -parafprint=100"
```

`FILE*` should be size 0.
`FILE07–39` should be size 0. (Credit: Leonid Gibiansky)

:::

## Model Evaluation

::: {.callout-tip}

### Significant improvement

* Don't directly associate OFVs with p-values ([Wählby et al. 2001](https://doi.org/10.1023/A:1011527125570))
    * Regard a drop in OFV with ~10 (Byon et al. 2013)
* boxcox ETA: dOFV > -10.827 (p < 0.001)

:::

::: {.callout-tip}

### Bias

#### Driving individuals

Compare iOFV values in the `.phi`-file between runs.

1. Sharkplot (ΔOFV (= OFV~full~ - OFV~reduced~) vs #subjects~removed~)
2. Should be able to remove 5 subjects without loosing significance.

#### Outlying observations

Do a sensitivity analysis for outliers (|CWRES| < 5).

1. Re-estimate model with the  outliers removed
2. Parameter estimates change -> Remove outliers
3. Parameter estimates **doesn’t** change -> Keep outliers

:::

::: {.callout-tip}

* ETA ShrinkageSD < 20% ? (then we can use EBE based diagnostics)
* EPS ShrinkageSD < 20% ? (then we can look at IPRED vs DV)
* VPC
* QA
* RSE% considered precise: < 30% for theta, < 50% for eta

* Condition number (CN) – `$COV PRINT=E`
    * Calculated differently in different software
        * In PsN it is calculated as dividing the largest eigenvalue with the smallest
        * Gabrielsson and Wiener calculates it as log(largest/smallest)
    * Different guidelines for ill-conditioning
        * If CN < 10p, where p = "number of estimable parameters", then it’s good
        * There are also references that point to CN < 106
        * < 1000 (seems to relate more to linear models, or PK-models with 3 parameters (CL, V, KA))
* SIR
* SADDLE_RESET
* MCETA
* NRD = Number of Required Digits
:::

::: {.callout-note}

## Notes

* `METHOD=IMPMAP` is equivalent to `METHOD=IMP MAPITER=1 MAPINTER=1`
* NONMEM places the low bound equal to 1/100 (or 1/1000) of the initial value even if it is set to zero in the code. You may rerun with lower initial value or put `NOTHETABOUNDTEST` to the estimation record. (Credit: Leonid Gibiansky)
* Mixture prior slide 31. Prior+flat prior "what if we are wrong". When conflict: up-weights data, downplays history
* `.ets`-file gets "random sampled ETAs" (less prone to shrinkage)
* Tab-separated (less likely to be present in the actual data)
* `EXIT(1)` instead of `p=0 /+1E-15` (Credit: Gunnar Yngman)
* Two-stage approach: Apply a model to each individuals data
    * Require much data per individual.
    * OK mean parameters (i.e. typical individual)
    * But IIV id inflated (also diff ID -> diff model)
* NONMEM: Apply a model to all individuals data
* .phi: Individual parameters: φi=μi+ηi, φi=(φ1,…,φn)
    * phc=Var(phi)
    * non_MU_ref parameters: φi=ηi


:::

## Interactive Control of NONMEM runs

Find the directory where NONMEM is running (`NM_run1/` in PsN) and manually create an empty file with a different name according to the desired action.

```bash
touch file.sig
```

Here's a list:

| Action | Description | Filename |
| :--- | :--- | :--- |
| Print toggle | Monitor estimation progress | `print.sig` |
| Paraprint toggle | Monitor parallel processing traffic | `paraprint.sig` |
| Next | Move on to next estimation mode or next estimation. NONMEM grinds a couple of iterations more and then it terminates nicely as if the maximum number of function evaluations had been reached. | `next.sig` |
| Stop | End the present run cleanly | `stop.sig` |
| Subject print toggle | | `subject.sig` |


[https://www.mail-archive.com/nmusers@globomaxnm.com/msg03990.html](https://www.mail-archive.com/nmusers@globomaxnm.com/msg03990.html)

(Credit: Paolo Denti)

## Random ETA samples:

When used in nonmem 7.5, a recommended example/setup would be (as shown on page 152 of nm750.pdf) 

```verilog
$SIZES ISAMPLEMAX=250

... 

$ESTIMATION METHOD=SAEM
            NBURN=500
            NITER=1000
            MASSRESET=1
            ISAMPLE=2
            PRINT=20
            NOPRIOR=1
            RANMETHOD=P

$ESTIMATION METHOD=SAEM
            NBURN=0
            NITER=0
            MASSRESET=0
            ETASAMPLES=1
            ISAMPLE=200
            EONLY=1 

$ESTIMATION METHOD=IMP
            NITER=5
            MASSRESET=1
            ETASAMPLES=0
            ISAMPLE=1000
            EONLY=1
            PRINT=1
            MAPITER=0 
```

(Credit: Robert Bauer)

## Instability of importance samping (IMP)

When building a relatively complex PKPD model (e.g. 47 parameters and 11 
differential equations), there can be issues using `FOCE` so an EM-method is warranted.

```verilog
$ESTIMATION METHOD=ITS
            INTERACTION
            LAPLACE
            NITER=200
            SIG=3
            PRINT=1
            SIGL=6
            NOHABORT 
            CTYPE=3
            NUMERICAL
            SLOW 

$ESTIMATION METHOD=IMPMAP
            INTERACTION
            LAPLACE
            ISAMPLE=1000
            NITER=1000
            SIG=3
            PRINT=1 
            SIGL=6
            NOHABORT
            CTYPE=3
            IACCEPT=0.4
            MAPITER=0
            RANMETHOD=3S2 

$COVARIANCE UNCONDITIONAL MATRIX=S TOL=12 SIGL=12 SLOW
```

The iterations for the initial `ITS` step seems in this case to be quite stable with some artefacts: 

```verilog
iteration 175 OBJ= 4693.4674554341409
iteration 176 OBJ= 4694.2296104065535
iteration 177 OBJ= 4693.7753507970829
iteration 178 OBJ= 4693.9600270372885
iteration 179 OBJ= 4693.5732455834705
iteration 180 OBJ= 4693.6386423202493
iteration 181 OBJ= 4693.6215390721527
iteration 182 OBJ= 4693.6006496138452
iteration 183 OBJ= 4693.7877620448235
iteration 184 OBJ= 4694.1591757809929
iteration 185 OBJ= 4693.2614956897451
iteration 186 OBJ= 4693.5641640401127
iteration 187 OBJ= 4693.5575289919379
iteration 188 OBJ= 4495.6489907149398
iteration 189 OBJ= 4693.7711764252363
iteration 190 OBJ= 4693.6281175153035
iteration 191 OBJ= 4694.1171774559862
iteration 192 OBJ= 4693.7908707845536
iteration 193 OBJ= 4693.7709264605819
iteration 194 OBJ= 4495.9262902940209
iteration 195 OBJ= 4693.3321354894242
iteration 196 OBJ= 4694.3177205227348
iteration 197 OBJ= 4694.1301486616576
iteration 198 OBJ= 4694.2898587322170
iteration 199 OBJ= 4693.8304358341920
iteration 200 OBJ= 4691.6818293505230

#TERM: 
OPTIMIZATION WAS NOT COMPLETED 
```

The IMP step can be less stable:

```verilog
iteration 120 OBJ= 4314.8310660241377 eff.= 446. Smpl.= 1000. Fit.= 0.96389
iteration 121 OBJ= 4326.9079856676717 eff.= 448. Smpl.= 1000. Fit.= 0.96409
iteration 122 OBJ= 4164.6649529423103 eff.= 479. Smpl.= 1000. Fit.= 0.96392
iteration 123 OBJ= 4299.9887619753636 eff.= 432. Smpl.= 1000. Fit.= 0.96395
iteration 124 OBJ= 4303.9571213327054 eff.= 399. Smpl.= 1000. Fit.= 0.96349
iteration 125 OBJ= 4328.9835950930074 eff.= 417. Smpl.= 1000. Fit.= 0.96423
iteration 126 OBJ= 4304.3861595488252 eff.= 550. Smpl.= 1000. Fit.= 0.96392
iteration 127 OBJ= 4291.0862736663648 eff.= 422. Smpl.= 1000. Fit.= 0.96430
iteration 128 OBJ= 4326.2378678645500 eff.= 407. Smpl.= 1000. Fit.= 0.96409
iteration 129 OBJ= 4157.5352046539456 eff.= 406. Smpl.= 1000. Fit.= 0.96404
iteration 130 OBJ= 4332.6894073732456 eff.= 399. Smpl.= 1000. Fit.= 0.96399
iteration 131 OBJ= 4357.5343346793761 eff.= 493. Smpl.= 1000. Fit.= 0.96414

Convergence achieved 

iteration 131 OBJ= 4336.1893012015007 eff.= 417. Smpl.= 1000. Fit.= 0.96369 

#TERM: 
OPTIMIZATION WAS COMPLETED 
```

::: {.callout-note}
If `eff.` divided by `Smpl.` is not approximately equal to `IACCEPT`, then tweak something.

`Fit.` tells you how Gaussian the profile is.
If `Fit.` is approximately 1, you might as well use `FOCE`.
If `Fit.` is more like 0.6, then `IMP` is a good choice.
:::

It is not unusual to see this large Monte Carlo noise in the OFV estimate.
It indicates that the number of samples (`ISAMPLE`) may not be high enough.

::: {.callout-tip}
When using the `IMP` method, it is adviced to include two sequential `$ESTIMATION` records.
The first record will perform optimization of parameter estimates until a global minimum is found.
The second record will then take those parameter estimates and calculate more precise estimates of the objective function value.
The second `$ESTIMATION` command will have a higher `ISAMPLE` to reduce the Monte Carlo noise, and have `EONLY=1` (no optimization of population parameters).
:::

In this case, perform another run with the parameter values set to their final estimates, and with: 

```verilog
$ESTIMATION METHOD=IMP
            INTERACTION
            LAPLACE
            ISAMPLE=10000 ; Number of samples
            NITER=5 ; Number of iterations
            SIG=3
            PRINT=1 
            SIGL=6
            EONLY=1 ; Perform only the expectation step
            NOHABORT
            RANMETHOD=3S2
```

The higher number of samples should give a more stable result (although the run time of each iteration will increase significantly).
Taking the **average OFV of these 5 iterations** will give a more accurate estimation of the final OFV. 

(Credit: Jon Moss)

## SAEM

[http://monolix.lixoft.com/tasks/population-parameter-estimation-using-saem/](http://monolix.lixoft.com/tasks/population-parameter-estimation-using-saem/)

## VPCs

The VPCs central metric are the prediction of data percentiles.
If you focus on the difference between e.g. the 5th and 95th percentile based on the simulated data you will have a prediction interval, like Bill states.
If you focus on an individual percentile, but consider the imprecision with which it is derived, often given as a shaded area, then it is like other metrics of imprecision a confidence interval.
Confidence interval (ci) and prediction interval (pi) for VPC.

In general, if the serum creatinine rises at 2–3 mg/dl per day then the GFR is near zero.

## University of Maryland

[https://ctm.umaryland.edu/#/ms-pharma](https://ctm.umaryland.edu/#/ms-pharma)

::: {.callout-note}

## Terminology

* Use "Disease modifying" instead of "protective" (Credit: Mats Karlsson)
* Time varying covariate: Specify as "regressor".

:::